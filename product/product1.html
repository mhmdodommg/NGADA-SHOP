<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุนุฑุถ ุงูููุชุฌ</title>
    <link rel="stylesheet" href="css/product.css">
      <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Beiruti:wght@200..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">  
   <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
       <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
    
    <div class="navbar">
    <div class="menu">
        <a href="http://localhost:8080/ngada%20shop/index.html"><i class="fas fa-home"></i> ุงูุฑุฆูุณูุฉ</a>
        <a href=""><i class="fas fa-user"></i> ุญุณุงุจู</a>
        <a href=""><i class="fas fa-info-circle"></i> ุนูุง</a>
        <a href=""><i class="fas fa-envelope"></i> ุชูุงุตู</a>
    </div>
</div>   
   <!-- ๐ ุณูุฉ ุงููุดุชุฑูุงุช -->
<div id="cart-popup" class="cart-popup">  
    <p id="empty-cart-message" style="color: red; font-weight: bold; display: none;"></p>  
    <h2>๐๏ธ ุณูุฉ ุงููุดุชุฑูุงุช</h2>  
    <ul id="cart-items"></ul>  
    <button onclick="clearCart()">ุฅูุฑุงุบ ุงูุณูุฉ</button>  
    <button onclick="toggleCartPopup()">ุฅุบูุงู</button>          
    <p><strong>ุงูุฅุฌูุงูู:</strong> <span id="total-price">0</span> ุฌููู</p>  
    <button onclick="checkout()">ุฅุชูุงู ุงูุทูุจ</button>  
</div>  

<!-- โ ูุงูุฐุฉ ุฅุฏุฎุงู ุจูุงูุงุช ุงูุนููู (ุฎุงุฑุฌ ุงูุณูุฉ) -->
<div id="checkout-form" class="hidden">  
    <h3>ุฅุฏุฎุงู ุจูุงูุงุช ุงูุทูุจ</h3>  
    <input type="text" id="customer-name" placeholder="ุงูุงุณู" required>  
    <input type="tel" id="customer-phone" placeholder="ุฑูู ุงููุงุชู" required>  
    <input type="tel" id="customer-whatsapp" placeholder="ุฑูู ุงููุงุชุณุงุจ" required>  
    <input type="text" id="customer-address" placeholder="ุงูุนููุงู" required>  

    <!-- ๐ฆ ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฏูุน -->
    <h4>ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน:</h4>
    <select id="payment-method" onchange="togglePaymentInfo()">
        <option value="cash">ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู</option>
        <option value="fawry">ููุฑู</option>
    </select>  

    <!-- ๐ณ ุจูุงูุงุช ุงูุฏูุน ุนุจุฑ ููุฑู -->
    <div id="fawry-info" class="hidden">
        <h4>ุชูุงุตูู ุงูุฏูุน ุนุจุฑ ููุฑู:</h4>
        <p><strong>๐น ุฑูู ุงูุญุณุงุจ:</strong> 123456789</p>
        <p><strong>๐น ุงุณู ุงููุณุชููุฏ:</strong> ููุชุจุฉ ุงูุณูุฏุงู</p>
        <p><strong>๐น ุจุนุฏ ุงูุฏูุนุ ุฃุฑุณู ุฅูุตุงู ุงูุชุญููู ุฅูู ูุงุชุณุงุจ: <span style="color: #ff5722;">0100000000</span></p>
    </div>
    <div id="overlay" class="hidden"></div>

<!-- ุงูููุงููุฉ ุนูู ุงูุดุฑูุท ูุงูุฃุญูุงู -->
<label for="terms-checkbox">
    <input type="checkbox" id="terms-checkbox"> ููุฏ ูุฑุฃุช ููุงููุช ุนูู  
</label>
<span onclick="openTermsPopup()" style="color: blue; cursor: pointer; text-decoration: underline;">
    ุงูุดุฑูุท ูุงูุฃุญูุงู
</span>

<!-- ูุงูุฐุฉ ุงูุดุฑูุท ูุงูุฃุญูุงู -->
<div id="terms-popup" class="hidden terms-popup">
    <div class="terms-content">
        <h3>ุงูุดุฑูุท ูุงูุฃุญูุงู</h3>
        <p>ุณูุงุณุฉ ุงูุทูุจุงุช ูุงูุฏูุน
ูุชู ุชุฃููุฏ ุงูุทูุจ ุจุนุฏ ุงุณุชููุงู ุนูููุฉ ุงูุฏูุน ุจุงููุงูู.
ุงูุฏูุน ูุชุงุญ ุนุจุฑ (ุงููุงุดุ ููุฑูุ ููุฏุงููู ูุงุด ).

ูู ุญุงู ูุฌูุฏ ุฎุทุฃ ูู ุงูุทูุจุ ูุฌุจ ุงูุชูุงุตู ูุนูุง ุฎูุงู 24 ุณุงุนุฉ ูู ุฅุชูุงู ุงูุนูููุฉ.

---
3. ุณูุงุณุฉ ุงูุดุญู ูุงูุชูุตูู

ูุชู ุชูุตูู ุงูุทูุจุงุช ุฏุงุฎู ููุงุฏุฉ ูุงูููุงุทู ุงููุฌุงูุฑุฉ ุฎูุงู (ุนุฏุฏ ุงูุฃูุงู ุงููุชููุน).

ุชูููุฉ ุงูุดุญู ูุชู ุชุญุฏูุฏูุง ุจูุงุกู ุนูู ุงูููุทูุฉ ูุทุฑููุฉ ุงูุชูุตูู.

ุงููุชุฌุฑ ุบูุฑ ูุณุคูู ุนู ุฃู ุชุฃุฎูุฑ ูุงุชุฌ ุนู ุดุฑูุงุช ุงูุดุญู ุฃู ุงูุธุฑูู ุงูุทุงุฑุฆุฉ.

---
4. ุณูุงุณุฉ ุงูุงุณุชุจุฏุงู ูุงูุงุณุชุฑุฌุงุน

ูุง ููุณูุญ ุจุงุณุชุฑุฌุงุน ุงูููุชุฌุงุช ุฅูุง ูู ุญุงูุฉ ูุฌูุฏ ุนูุจ ูุตูุนู ุฃู ุฎุทุฃ ูู ุงูุทูุจ.

ูุฌุจ ุงูุฅุจูุงุบ ุนู ุงููุดููุฉ ุฎูุงู (ุนุฏุฏ ุงูุฃูุงูุ ูุซู 48 ุณุงุนุฉ) ูู ุงุณุชูุงู ุงูุทูุจ.

ูุง ูููุจู ุงุณุชุฑุฌุงุน ุงูููุชุฌุงุช ุงูุชู ุชู ุงุณุชุฎุฏุงููุง ุฃู ูุชุญูุงุ ุจุงุณุชุซูุงุก ุงูุนููุจ ุงููุตูุนูุฉ.

ูุชุญูู ุงูุนููู ุชูุงููู ุงูุดุญู ุนูุฏ ุงูุงุณุชุจุฏุงู ุฃู ุงูุงุณุชุฑุฌุงุนุ ูุง ูู ููู ุงูุฎุทุฃ ูู ุงููุชุฌุฑ.

---
5. ุณูุงุณุฉ ุงูุฎุตูุตูุฉ ูุญูุงูุฉ ุงูุจูุงูุงุช

ููุชุฒู ุจุญูุงูุฉ ุจูุงูุงุช ุงูุนููุงุก ูุนุฏู ูุดุงุฑูุชูุง ูุน ุฃู ุทุฑู ุซุงูุซ ุฏูู ุฅุฐู ูุณุจู.

ูุชู ุงุณุชุฎุฏุงู ุงููุนูููุงุช ุงูุดุฎุตูุฉ ููุท ููุนุงูุฌุฉ ุงูุทูุจุงุช ูุงูุชูุงุตู ูุน ุงูุนููุงุก.

---
6. ุญููู ุงููุชุฌุฑ

ูุญุชูุธ ุงููุชุฌุฑ ุจุงูุญู ูู ุชุนุฏูู ุงูุฃุณุนุงุฑ ุฃู ุงูุณูุงุณุงุช ุฏูู ุฅุดุนุงุฑ ูุณุจู.

ูุญู ูููุชุฌุฑ ุฑูุถ ุฃู ุฅูุบุงุก ุฃู ุทูุจ ูู ุญุงู ุงูุงุดุชุจุงู ูู ุงุญุชูุงู ุฃู ุณูุก ุงุณุชุฎุฏุงู ููุฎุฏูุฉ.

ูููุน ุงุณุชุฎุฏุงู ุฃู ูุญุชูู ูู ุงููุชุฌุฑ (ุตูุฑุ ูุตูุตุ ุชุตุงููู) ุฏูู ุฅุฐู ูุณุจู.
---
7. ุงูุชูุงุตู ูุงูุฏุนู
ูููู ุงูุชูุงุตู ูุนูุง ุนุจุฑ (ุงุฐูุฑ ุทุฑู ุงูุชูุงุตู ูุซู ูุงุชุณุงุจุ ููุณุจููุ ุฑูู ุงููุงุชู).
ุณุงุนุงุช ุงูุนูู ุงูุฑุณููุฉ: (ุญุฏุฏ ุงูุฃููุงุช ูุงูุฃูุงู ุงูุชู ูุชู ูููุง ุงูุฑุฏ ุนูู ุงูุนููุงุก).
---

ุชูุจูู ูุงู ููุนููุงุก ุจุดุฃู ุงูุชูุงุนุจ ุจุงูุทูุจุงุช

ูุญุฑุต ูู ูุชุฌุฑ ูุฏููุฉ ููุงุฏุฉ ุนูู ุชูุฏูู ุฃูุถู ุฎุฏูุฉ ููููุฉ ูุนููุงุฆูุงุ ููุนูู ุจุฌุฏ ูุถูุงู ูุตูู ุงูุทูุจุงุช ุจุณุฑุนุฉ ูุฏูุฉ. ููููู ุงูู ูู ุญุงู ุญุตูู ุงู ุดุฆ ูู ุงูุงุชู:

ุชูุฏูู ุทูุจุงุช ููููุฉ ูุนุฏู ุงุณุชูุงููุง.

ุฅูุบุงุก ุงูุทูุจุงุช ุงููุชูุฑุฑ ุจุฏูู ุณุจุจ ูููุน.

ูุญุงููุฉ ุงุณุชุบูุงู ุณูุงุณุงุช ุงูุงุณุชุจุฏุงู ูุงูุงุณุชุฑุฌุงุน ุจุทุฑู ุบูุฑ ูุดุฑูุนุฉ.
 ูุฅููุง ุณูุชุฎุฐ ุงูุฅุฌุฑุงุกุงุช ุงูููุงุณุจุฉุ ูุงูุชู ูุฏ ุชุดูู:
 
ุญุธุฑ ุงูุนููู ูู ุงูุทูุจ ูุณุชูุจูุงู.

ุฑูุถ ุชูููุฐ ุงูุทูุจุงุช ุงููุดุจููุฉ.

ุงูุฅุจูุงุบ ุนู ุฃู ูุญุงููุงุช ุงุญุชูุงููุฉ.

ูุญู ูุซู ุจุนููุงุฆูุง ุงููุฑุงู ูููุฏูุฑ ุชุนุงูููู ุงูุฌุงุฏ ูุนูุงุ ูุฐุง ูุฃูู ุงูุงูุชุฒุงู ุจุงูุดูุงููุฉ ูุงููุตุฏุงููุฉ ูุถูุงู ุงุณุชูุฑุงุฑูุฉ ุงูุฎุฏูุฉ ุจุฃูุถู ุดูู ูููู.
ุดูุฑุงู ูุชููููู ูุชุนุงูููู .</p>
        <button onclick="closeTermsPopup()">ุฅุบูุงู</button>
    </div>
</div>
    <button onclick="submitOrder()">ุฅุฑุณุงู ุงูุทูุจ</button>  
    <button onclick="closeCheckout()">ุฅุบูุงู</button>  
</div>
  <!-- ุฒุฑ ุณูุฉ ุงููุดุชุฑูุงุช -->    
<button class="cart-btn" onclick="toggleCartPopup()">  
    ๐ <span id="cart-count">0</span>  
</button>   
    <div class="product">
           <a href="javascript:history.back()" class="back-button">ใ<br>ุนูุฏุฉ</a>
        <img src="img/product1.jpg" alt="ุตูุฑุฉ ุงูููุชุฌ" class="product-img">
        <div class="product-info">
            <h2>ุดุจุดุจ ุจูุชู</h2>
            <p class="price">ุงูุณุนุฑ: 100 ุฌููู</p>
            <p class="description">ุดุจุดุจ ุจูุชู ุฌููู ูุงููู ุจุฎุงูุงุช ููุชุงุฒุฉ ููุชููุฉ ุจุงููุงู ุฌูููุฉ ูุฑุงุฆุนุฉ ุชุฏูู ุทูููุง </p>
                  <p>:ุงููููุฉ</p>
   <div class="quantity-selector" data-price="100">
    <button class="minus">-</button>
    <input type="text" id="quantity" value="1" readonly>
    <button class="plus">+</button>   
</div>       
<p class="total-price">ุงูุฅุฌูุงูู: <span id="total">100</span> ุฌููู</p>
  <button  class="buy-btn" data-name="ุดุจุดุจ ุจูุชู" data-price="100" onclick="addToCart(this)"onclick="toggleCartPopup()" >ุฅุถุงูุฉ ุฅูู ุงูุณูุฉ</button>       
    </div>               
<div class="product" id="product1">
    <h1>ููู ุงูููุชุฌ</h1>
    <div class="stars" id="stars-product1">
        <span class="star" data-rating="1">&#9733;</span>
        <span class="star" data-rating="2">&#9733;</span>
        <span class="star" data-rating="3">&#9733;</span>
        <span class="star" data-rating="4">&#9733;</span>
        <span class="star" data-rating="5">&#9733;</span>
    </div>
    <input type="text" class="re-com" id="username-product1" placeholder="ุงุณูู">
    <textarea id="comment-product1" class="re-com" placeholder="ุฃุถู ุชุนูููู ููุง..."></textarea>
    <button onclick="submitRating('product1')" class="ret-bt">ุฅุฑุณุงู ุงูุชูููู</button>
    
    <div id="error-message-product1" class="error-message" style="display:none;">
        ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูุชูููู ูุชุนููู
    </div>
    
    <div id="success-message-product1" class="success-message" style="display:none;">
        ุชู ุญูุธ ุงูุชูููู ุจูุฌุงุญ!
    </div>
    
    <div class="previous-ratings">
        <p id="average-rating-product1" class="average-rating"></p>
        <h2>ุงูุชููููุงุช ุงูุณุงุจูุฉ</h2>
        <div id="ratings-list-product1" class="ratings-list"></div>
    </div>
</div>
<script>
    // ุชููุฆุฉ Firebase
const firebaseConfig = {
    apiKey: "AIzaSyADxRfJY9-W1TZE-zWXc1zFeiHpidsXbug",
    authDomain: "coment-a7ac2.firebaseapp.com",
    databaseURL: "https://coment-a7ac2-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "coment-a7ac2",
    storageBucket: "coment-a7ac2.appspot.com",
    messagingSenderId: "1088742650545",
    appId: "1:1088742650545:web:c66518ea620db96b46e890"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ูุชุบูุฑุงุช ุงููุธุงู
let currentRating = 0;
const ADMIN_PASSWORD = "admin123"; // ูููุฉ ุณุฑ ููุญุฉ ุงูุชุญูู

// ุนูุฏ ุชุญููู ุงูุตูุญุฉ
window.onload = function() {
    initStars('product1');
    loadRatings('product1');
    checkAdminAccess();
    addStyles(); // ุฅุถุงูุฉ ุงูุฃููุงุท ุฏููุงููููุงู
};

// ============== ูุธุงู ุงูุชููููุงุช ============== //

// ุชููุฆุฉ ุงููุฌูู
function initStars(productId) {
    const stars = document.querySelectorAll(`#stars-${productId} .star`);
    stars.forEach(star => {
        star.addEventListener('click', function() {
            currentRating = parseInt(this.getAttribute('data-rating'));
            updateStars(productId, currentRating);
        });
    });
}

// ุชุญุฏูุซ ุญุงูุฉ ุงููุฌูู
function updateStars(productId, rating) {
    const stars = document.querySelectorAll(`#stars-${productId} .star`);
    stars.forEach((star, index) => {
        star.style.color = index < rating ? '#ffc107' : '#ccc';
    });
}

// ุชุญููู ุงูุชููููุงุช
function loadRatings(productId) {
    console.log(`ุฌุงุฑู ุชุญููู ุงูุชููููุงุช ููููุชุฌ: ${productId}`);
    
    database.ref('ratings/' + productId).orderByChild('date').on('value', (snapshot) => {
        const ratings = snapshot.val();
        console.log("ุงูุจูุงูุงุช ุงููุณุชููุฉ:", ratings);
        
        const ratingsList = document.getElementById(`ratings-list-${productId}`);
        if (!ratingsList) {
            console.error(`ุงูุนูุตุฑ ratings-list-${productId} ุบูุฑ ููุฌูุฏ`);
            return;
        }
        
        ratingsList.innerHTML = "";
        
        if (!ratings || Object.keys(ratings).length === 0) {
            ratingsList.innerHTML = `<div class="no-ratings">ูุง ุชูุฌุฏ ุชููููุงุช ุจุนุฏ. ูู ุฃูู ูู ูููู!</div>`;
            return;
        }

        let totalRating = 0;
        let count = 0;

        Object.entries(ratings).forEach(([ratingId, rating]) => {
            if (rating.status !== 'removed') {
                totalRating += rating.rating;
                count++;
                
                const ratingItem = createRatingItem(productId, ratingId, rating);
                ratingsList.appendChild(ratingItem);
                loadVoteCounters(productId, ratingId);
            }
        });

        // ุชุญุฏูุซ ูุชูุณุท ุงูุชูููู
        updateAverageRating(productId, totalRating, count);
    }, (error) => {
        console.error("Error loading ratings:", error);
        const ratingsList = document.getElementById(`ratings-list-${productId}`);
        if (ratingsList) {
            ratingsList.innerHTML = `<div class="error-msg">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุชููููุงุช</div>`;
        }
    });
}

// ุฅูุดุงุก ุนูุตุฑ ุงูุชูููู
function createRatingItem(productId, ratingId, rating) {
    const ratingItem = document.createElement('div');
    ratingItem.className = 'rating-item';
    ratingItem.id = `rating-${ratingId}`;
    ratingItem.innerHTML = `
        <div class="rating-header">
            <strong class="rating-username">${rating.username}</strong>
            <div class="rating-stars">${generateStars(rating.rating)}</div>
        </div>
        <p class="rating-comment">${rating.comment}</p>
        <small class="rating-date">${formatDate(rating.date)}</small>
        
        <div class="rating-actions">
            <div class="useful-rating">
                <button class="helpful-btn" onclick="voteHelpful(true, '${ratingId}', '${productId}')">
                    ๐ ูููุฏ (<span id="helpful-count-${productId}-${ratingId}">0</span>)
                </button>
                <button class="not-helpful-btn" onclick="voteHelpful(false, '${ratingId}', '${productId}')">
                    ๐ ุบูุฑ ูููุฏ (<span id="not-helpful-count-${productId}-${ratingId}">0</span>)
                </button>
            </div>
            
            <div class="report-section">
                <select id="report-reason-${ratingId}" class="report-reason">
                    <option value="spam">ูุญุชูู ูุฒุนุฌ</option>
                    <option value="abuse">ุฅุณุงุกุฉ</option>
                    <option value="wrong">ูุนูููุงุช ุฎุงุทุฆุฉ</option>
                </select>
                <button class="report-btn" onclick="reportRating('${productId}', '${ratingId}')">
                    ุฅุจูุงุบ
                </button>
            </div>
        </div>
    `;
    return ratingItem;
}

// ุฅุฑุณุงู ุชูููู ุฌุฏูุฏ
function submitRating(productId) {
    const username = document.getElementById(`username-${productId}`).value.trim();
    const comment = document.getElementById(`comment-${productId}`).value.trim();
    
    // ุงูุชุญูู ูู ุงูุญููู
    if (!username) {
        showAlert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณูู', 'error');
        return;
    }
    if (!comment) {
        showAlert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุชุนููู', 'error');
        return;
    }
    if (currentRating === 0) {
        showAlert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุชูููู ูู 1 ุฅูู 5 ูุฌูู', 'error');
        return;
    }

    const newRating = {
        username: username,
        rating: currentRating,
        comment: comment,
        date: new Date().toISOString(),
        status: 'active'
    };

    database.ref('ratings/' + productId).push(newRating)
        .then(() => {
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุญููู
            document.getElementById(`username-${productId}`).value = "";
            document.getElementById(`comment-${productId}`).value = "";
            currentRating = 0;
            updateStars(productId, 0);
            
            showAlert('ุดูุฑุงู ูุชููููู! ุชู ุงูุญูุธ ุจูุฌุงุญ', 'success');
        })
        .catch((error) => {
            console.error("Error submitting rating:", error);
            showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชูููู', 'error');
        });
}

// ============== ูุธุงู ุงูุชุตููุช (ูููุฏ/ุบูุฑ ูููุฏ) ============== //

function voteHelpful(isHelpful, ratingId, productId) {
    const userKey = generateUserKey();
    const voteRef = database.ref(`votes/${productId}/${ratingId}/${userKey}`);
    
    // ุงูุชุญูู ูู ุงูุชุตููุช ุงูุณุงุจู
    voteRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
            showAlert('ููุฏ ููุช ุจุงูุชุตููุช ุนูู ูุฐุง ุงูุชุนููู ูุณุจูุงู', 'info');
            return;
        }
        
        // ุชุณุฌูู ุงูุชุตููุช ุงูุฌุฏูุฏ
        return voteRef.set({
            helpful: isHelpful,
            timestamp: Date.now()
        });
    }).then(() => {
        updateVoteCounters(productId, ratingId);
        showAlert(`ุดูุฑุงู ูู! ุชู ุชุณุฌูู ุชุตููุชู ุนูู ุฃู ูุฐุง ุงูุชุนููู ${isHelpful ? 'ูููุฏ' : 'ุบูุฑ ูููุฏ'}`, 'success');
    }).catch(error => {
        console.error("Error in voting:", error);
        showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุชุตููุชู', 'error');
    });
}

function updateVoteCounters(productId, ratingId) {
    const votesRef = database.ref(`votes/${productId}/${ratingId}`);
    
    votesRef.once('value').then(snapshot => {
        let helpfulCount = 0;
        let notHelpfulCount = 0;
        const votes = snapshot.val() || {};
        
        Object.values(votes).forEach(vote => {
            vote.helpful ? helpfulCount++ : notHelpfulCount++;
        });
        
        // ุชุญุฏูุซ ุงููุงุฌูุฉ
        const helpfulElement = document.getElementById(`helpful-count-${productId}-${ratingId}`);
        const notHelpfulElement = document.getElementById(`not-helpful-count-${productId}-${ratingId}`);
        
        if (helpfulElement) helpfulElement.textContent = helpfulCount;
        if (notHelpfulElement) notHelpfulElement.textContent = notHelpfulCount;
    });
}

// ============== ูุธุงู ุงูุฅุจูุงุบ ============== //

function reportRating(productId, ratingId) {
    const reasonSelect = document.getElementById(`report-reason-${ratingId}`);
    const reason = reasonSelect ? reasonSelect.value : "ุบูุฑ ูุญุฏุฏ";
    const reasonText = getReasonText(reason);
    
    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุฅุจูุงุบ ุนู ูุฐุง ุงูุชุนูููุ\nุงูุณุจุจ: ${reasonText}`)) {
        const reportRef = database.ref(`reports/${Date.now()}`);
        
        const reportData = {
            productId: productId,
            ratingId: ratingId,
            reason: reason,
            date: new Date().toISOString(),
            status: "pending"
        };
        
        reportRef.set(reportData)
        .then(() => {
            markAsReported(ratingId);
            checkReportCount(productId, ratingId);
            showAlert('ุชู ุชุณุฌูู ุจูุงุบู ุจูุฌุงุญ ูุณูุชู ูุฑุงุฌุนุชู', 'success');
        })
        .catch(error => {
            console.error("Error saving report:", error);
            showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุจูุงุบ', 'error');
        });
    }
}

function checkReportCount(productId, ratingId) {
    const reportsRef = database.ref('reports').orderByChild('ratingId').equalTo(ratingId);
    
    reportsRef.once('value').then(snapshot => {
        const reportCount = snapshot.numChildren();
        if (reportCount >= 3) {
            database.ref(`ratings/${productId}/${ratingId}/status`).set('under_review')
                .then(() => {
                    console.log(`ุชู ูุถุน ุงูุชุนููู ${ratingId} ุชุญุช ุงููุฑุงุฌุนุฉ`);
                });
        }
    });
}

// ============== ููุญุฉ ุชุญูู ุงููุดุฑู ============== //

function checkAdminAccess() {
    const urlParams = new URLSearchParams(window.location.search);
    const adminKey = urlParams.get('admin');
    
    if (adminKey === ADMIN_PASSWORD) {
        showAdminPanel();
        loadReports();
    }
}

function showAdminPanel() {
    const panel = document.createElement('div');
    panel.id = 'admin-panel';
    panel.innerHTML = `
        <div class="admin-panel-header">
            <h3>ููุญุฉ ุชุญูู ุงููุดุฑู</h3>
            <button onclick="closeAdminPanel()" class="close-admin-btn">โ</button>
        </div>
        <div class="reports-container">
            <h4>ุงูุจูุงุบุงุช ุงูุฌุฏูุฏุฉ</h4>
            <div id="reports-list" class="reports-list"></div>
        </div>
    `;
    document.body.appendChild(panel);
    addAdminPanelStyles();
}

function loadReports() {
    database.ref('reports').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
        const reports = snapshot.val() || {};
        const reportsList = document.getElementById('reports-list');
        if (!reportsList) return;
        
        reportsList.innerHTML = "";
        
        if (Object.keys(reports).length === 0) {
            reportsList.innerHTML = '<p class="no-reports">ูุง ุชูุฌุฏ ุจูุงุบุงุช ุฌุฏูุฏุฉ</p>';
            return;
        }

        Object.entries(reports).forEach(([reportId, report]) => {
            const reportItem = createReportItem(reportId, report);
            reportsList.appendChild(reportItem);
        });
    });
}

function createReportItem(reportId, report) {
    const item = document.createElement('div');
    item.className = 'report-item';
    item.innerHTML = `
        <div class="report-header">
            <span class="report-id">#${reportId.substr(-6)}</span>
            <span class="report-date">${formatDate(report.date)}</span>
        </div>
        <div class="report-details">
            <p><strong>ุงูููุชุฌ:</strong> ${report.productId}</p>
            <p><strong>ุงูุณุจุจ:</strong> ${getReasonText(report.reason)}</p>
        </div>
        <div class="report-actions">
            <button onclick="handleReport('${reportId}', 'delete', '${report.productId}', '${report.ratingId}')" class="delete-btn">
                ุญุฐู ุงูุชุนููู
            </button>
            <button onclick="handleReport('${reportId}', 'ignore')" class="ignore-btn">
                ุชุฌุงูู ุงูุจูุงุบ
            </button>
        </div>
    `;
    return item;
}

function handleReport(reportId, action, productId, ratingId) {
    const updates = {
        status: 'resolved',
        action: action,
        resolvedAt: new Date().toISOString()
    };
    
    if (action === 'delete' && productId && ratingId) {
        database.ref(`ratings/${productId}/${ratingId}/status`).set('removed')
            .then(() => {
                showAlert('ุชู ุญุฐู ุงูุชุนููู ุจูุฌุงุญ', 'success');
            });
    }
    
    database.ref(`reports/${reportId}`).update(updates)
        .then(() => {
            loadReports();
        });
}

// ============== ูุธุงุฆู ูุณุงุนุฏุฉ ============== //

function generateUserKey() {
    if (!localStorage.getItem('userKey')) {
        localStorage.setItem('userKey', Math.random().toString(36).substr(2, 9));
    }
    return 'user_' + localStorage.getItem('userKey');
}

function generateStars(rating) {
    let stars = "";
    for (let i = 1; i <= 5; i++) {
        stars += i <= rating ? 'โ' : 'โ';
    }
    return stars;
}

function updateAverageRating(productId, totalRating, count) {
    const average = count > 0 ? (totalRating / count).toFixed(1) : 0;
    const averageElement = document.getElementById(`average-rating-${productId}`);
    if (averageElement) {
        averageElement.innerHTML = `ูุชูุณุท ุงูุชูููู: ${generateStars(Math.round(average))} <span class="average-number">(${average} ูู 5)</span>`;
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('ar-EG');
}

function getReasonText(reason) {
    const reasons = {
        'spam': 'ูุญุชูู ูุฒุนุฌ',
        'abuse': 'ุฅุณุงุกุฉ',
        'wrong': 'ูุนูููุงุช ุฎุงุทุฆุฉ',
        'other': 'ุฃุณุจุงุจ ุฃุฎุฑู'
    };
    return reasons[reason] || reason;
}

function markAsReported(ratingId) {
    const ratingElement = document.getElementById(`rating-${ratingId}`);
    if (ratingElement) {
        ratingElement.classList.add('reported');
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// ============== ุฅุถุงูุฉ ุงูุฃููุงุท ุฏููุงููููุงู ============== //

function addStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* ุฃููุงุท ุงูุชููููุงุช */
        .rating-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .rating-item.reported {
            border-left: 3px solid #f44336;
            background-color: #ffebee;
        }
        
        .rating-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .rating-stars {
            color: #ffc107;
            font-size: 18px;
        }
        
        .rating-comment {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .rating-date {
            color: #757575;
            font-size: 12px;
        }
        
        .rating-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .useful-rating {
            display: flex;
            gap: 10px;
        }
        
        .helpful-btn, .not-helpful-btn {
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .helpful-btn {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .not-helpful-btn {
            background: #ffebee;
            color: #c62828;
        }
        
        .report-section {
            display: flex;
            gap: 8px;
        }
        
        .report-reason {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .report-btn {
            background: #ffebee;
            color: #c62828;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* ููุญุฉ ุงูุชุญูู */
        #admin-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 350px;
            max-height: 80vh;
            background: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .admin-panel-header {
            background: #1976d2;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-admin-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .reports-container {
            padding: 15px;
        }
        
        .reports-list {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .report-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .report-id {
            font-weight: bold;
        }
        
        .report-date {
            color: #757575;
        }
        
        .report-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .delete-btn, .ignore-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .delete-btn {
            background: #ffebee;
            color: #c62828;
        }
        
        .ignore-btn {
            background: #e0e0e0;
            color: #424242;
        }
        
        /* ุงูุชูุจููุงุช */
        .alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
        }
        
        .alert-success {
            background: #4caf50;
        }
        
        .alert-error {
            background: #f44336;
        }
        
        .alert-info {
            background: #2196f3;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* ุงูุนูุงุตุฑ ุงูุนุงูุฉ */
        .no-ratings, .no-reports, .error-msg {
            text-align: center;
            padding: 20px;
            color: #757575;
        }
        
        .average-rating {
            font-size: 16px;
            margin: 15px 0;
        }
        
        .average-number {
            color: #ff9800;
            font-weight: bold;
        }
    `;
    document.head.appendChild(style);
}

function addAdminPanelStyles() {
    const style = document.createElement('style');
    style.textContent = `
        #admin-panel {
            font-family: Arial, sans-serif;
        }
        
        #admin-panel h3, #admin-panel h4 {
            margin: 0;
        }
        
        .reports-container h4 {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
    `;
    document.head.appendChild(style);
}

function closeAdminPanel() {
    const panel = document.getElementById('admin-panel');
    if (panel) {
        panel.remove();
    }
}
</script>
    <script src="product.js"></script>
</body>
</html>
